version: "3.8"

services:
  nginx:
    image: nginx:alpine
    container_name: nginx
    ports:
      - "8080:80"
    depends_on:
      user-service:
        condition: service_healthy
      patient-data-service:
        condition: service_healthy
      analytics-service:
        condition: service_healthy
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    restart: unless-stopped

  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    environment:
      - ROOT_PATH=/users
      - POSTGRES_DB=${POSTGRES_DB:-users}
      - POSTGRES_USER=${POSTGRES_USER:-user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-password}
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres-user}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - DATABASE_URL=postgresql://${POSTGRES_USER:-user}:${POSTGRES_PASSWORD:-password}@${POSTGRES_HOST:-postgres-user}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-users}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
    depends_on:
      postgres-user:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  patient-data-service:
    build:
      context: ./patient-data-service
      dockerfile: Dockerfile
    deploy:
      mode: replicated
      replicas: 3
    environment:
      - ROOT_PATH=/patient
      - TIMESCALE_DB=${TIMESCALE_DB:-patientdata}
      - TIMESCALE_USER=${TIMESCALE_USER:-tsuser}
      - TIMESCALE_PASSWORD=${TIMESCALE_PASSWORD:-tspassword}
      - TIMESCALE_HOST=${TIMESCALE_HOST:-timescale-data}
      - TIMESCALE_PORT=${TIMESCALE_PORT:-5432}
      - DATABASE_URL=postgresql://${TIMESCALE_USER:-tsuser}:${TIMESCALE_PASSWORD:-tspassword}@${TIMESCALE_HOST:-timescale-data}:${TIMESCALE_PORT:-5432}/${TIMESCALE_DB:-patientdata}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
    depends_on:
      timescale-data:
        condition: service_healthy
      redis:
        condition: service_healthy
      user-service:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  analytics-service:
    build:
      context: ./analytics-service
      dockerfile: Dockerfile
    environment:
      - ROOT_PATH=/analytics
      - ANALYTICS_DB_NAME=${ANALYTICS_DB_NAME:-analytics}
      - ANALYTICS_DB_USER=${ANALYTICS_DB_USER:-analytics}
      - ANALYTICS_DB_PASSWORD=${ANALYTICS_DB_PASSWORD:-analytics}
      - ANALYTICS_DB_HOST=${ANALYTICS_DB_HOST:-postgres-analytics}
      - ANALYTICS_DB_PORT=${ANALYTICS_DB_PORT:-5432}
      - DATABASE_URL=postgresql://${ANALYTICS_DB_USER:-analytics}:${ANALYTICS_DB_PASSWORD:-analytics}@${ANALYTICS_DB_HOST:-postgres-analytics}:${ANALYTICS_DB_PORT:-5432}/${ANALYTICS_DB_NAME:-analytics}
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
    depends_on:
      postgres-analytics:
        condition: service_healthy
      redis:
        condition: service_healthy
      patient-data-service:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  alerts-service:
    build:
      context: ./alerts-service
      dockerfile: Dockerfile
    environment:
      - ROOT_PATH=/alerts
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - TWILIO_TEST_MODE=${TWILIO_TEST_MODE:-true}
      - TWILIO_API_KEY=${TWILIO_API_KEY}
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN}
      - TWILIO_FROM_NUMBER=${TWILIO_FROM_NUMBER}
      - TEST_PHONE_NUMBER=${TEST_PHONE_NUMBER}
      - ALERTS_DB_NAME=${ALERTS_DB_NAME:-alerts}
      - ALERTS_DB_USER=${ALERTS_DB_USER:-alerts}
      - ALERTS_DB_PASSWORD=${ALERTS_DB_PASSWORD:-alerts}
      - ALERTS_DB_HOST=${ALERTS_DB_HOST:-postgres-alerts}
      - ALERTS_DB_PORT=${ALERTS_DB_PORT:-5432}
      - DATABASE_URL=postgresql://${ALERTS_DB_USER:-alerts}:${ALERTS_DB_PASSWORD:-alerts}@${ALERTS_DB_HOST:-postgres-alerts}:${ALERTS_DB_PORT:-5432}/${ALERTS_DB_NAME:-alerts}
    depends_on:
      redis:
        condition: service_healthy
      analytics-service:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  postgres-user:
    image: postgres:15
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-user}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-password}
      - POSTGRES_DB=${POSTGRES_DB:-users}
    volumes:
      - user_db_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB} || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  timescale-data:
    image: timescale/timescaledb:latest-pg15
    environment:
      - POSTGRES_USER=${TIMESCALE_USER:-tsuser}
      - POSTGRES_PASSWORD=${TIMESCALE_PASSWORD:-tspassword}
      - POSTGRES_DB=${TIMESCALE_DB:-patientdata}
    volumes:
      - patient_data_db:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${TIMESCALE_USER} -d ${TIMESCALE_DB} || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  postgres-analytics:
    image: postgres:15
    environment:
      - POSTGRES_USER=${ANALYTICS_DB_USER:-analytics}
      - POSTGRES_PASSWORD=${ANALYTICS_DB_PASSWORD:-analytics}
      - POSTGRES_DB=${ANALYTICS_DB_NAME:-analytics}
    volumes:
      - analytics_db_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${ANALYTICS_DB_USER} -d ${ANALYTICS_DB_NAME} || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  postgres-alerts:
    image: postgres:15
    environment:
      - POSTGRES_USER=${ALERTS_DB_USER:-alerts}
      - POSTGRES_PASSWORD=${ALERTS_DB_PASSWORD:-alerts}
      - POSTGRES_DB=${ALERTS_DB_NAME:-alerts}
    volumes:
      - alerts_db_data:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${ALERTS_DB_USER} -d ${ALERTS_DB_NAME} || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    restart: unless-stopped
    volumes:
      - redis-data:/data
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  pgadmin:
    image: dpage/pgadmin4
    environment:
      - PGADMIN_DEFAULT_EMAIL=${PGADMIN_DEFAULT_EMAIL:-admin@example.com}
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_DEFAULT_PASSWORD:-admin}
    ports:
      - "5050:80"
    depends_on:
      postgres-user:
        condition: service_healthy
      postgres-analytics:
        condition: service_healthy
      timescale-data:
        condition: service_healthy
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    restart: unless-stopped

volumes:
  user_db_data:
  patient_data_db:
  analytics_db_data:
  alerts_db_data:
  redis-data: 
  pgadmin-data: